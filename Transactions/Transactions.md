# Transactions

## Microservices shared DB per service (without transaction pattern):
![link](https://drive.google.com/uc?id=1yuSmjUFZb3GzafBfO45MmywPt2637Blx)

## The Problem: how to make in persistent and consistent?:
![link](https://drive.google.com/uc?id=1hy1ZBc997YpEjbyU-CNzmNSv7kkZIkls)

**Транзакция** - задает последовательность инструкций языка Transact-SQL, применяемую программистами базы данных для объединения в один пакет операций чтения и записи для того, чтобы система базы данных могла обеспечить согласованность данных. 

**Существует два типа транзакций**:
 - **Неявная транзакция** - задает любую отдельную инструкцию INSERT, UPDATE или DELETE как единицу транзакции.
 - **Явная транзакция** - обычно это группа инструкций языка Transact-SQL, начало и конец которой обозначаются такими инструкциями, как BEGIN TRANSACTION, COMMIT и ROLLBACK.

**Основные концепции транзакции описываются аббревиатурой ACID – Atomicity, Consistency, Isolation, Durability (Атомарность, Согласованность, Изолированность, Долговечность):**
 - **Атомарность** гарантирует, что любая транзакция будет зафиксирована только целиком (полностью). Если одна из операций в последовательности не будет выполнена, то вся транзакция будет отменена. Тут вводится понятие “отката” (rollback). Т.е. внутри последовательности будут происходить определённые изменения, но по итогу все они будут отменены (“откачены”) и по итогу пользователь не увидит никаких изменений.
 - **Согласованность** означает, что любая завершённая транзакция (транзакция, которая достигла завершения транзакции – end of transaction) фиксирует только допустимые результаты. Например, при переводе денег с одного счёта на другой, в случае, если деньги ушли с одного счёта, они должны прийти на другой (это и есть согласованность системы). Списание и зачисление  – это две разные транзакции, поэтому первая транзакция пройдёт без ошибок, а второй просто не будет. Именно поэтому крайне важно учитывать это свойство и поддерживать баланс системы.
 - **Изолированность** - каждая транзакция должна быть изолирована от других, т.е. её результат не должен зависеть от выполнения других параллельных транзакций. На практике, изолированность крайне труднодостижимая вещь, поэтому здесь вводится понятие “уровни изолированности” (транзакция изолируется не полностью).
 - **Долговечность** - концепция гарантирует, что если мы получили подтверждение о выполнении транзакции, то изменения, вызванные этой транзакцией не должны быть отменены из-за сбоя системы (например, отключение электропитания).

**SQL main transaction commands**:
 - BEGIN (начинает блок транзакций);
 - COMMIT (сохраняет изменения);
 - ROLLBACK (откатывает (отменяет) изменения);
 - SAVEPOINT (создаёт точку к которой группа транзакций может откатиться);

## Example:

### Connection1:
```sql
BEGIN;
UPDATE users SET bank_account = bank_account - 50.00
    WHERE name = 'User 1';
-- etc etc
COMMIT;
SAVEPOINT my_savepoint;
```

### Connection3:
```sql
BEGIN;
UPDATE users SET bank_account = bank_account + 250.00
    WHERE name = 'User 1';
-- etc etc
-- oops ... ERROR!!!!!!!!!!!
ROLLBACK TO my_savepoint;
```
### Shared DB per service (CLASSIC ACID transaction pattern):
![link](https://drive.google.com/uc?id=1nur6dQF5hwX163kg9WFnrLoRJKEl7yuD)


